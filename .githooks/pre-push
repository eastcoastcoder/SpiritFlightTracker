#!/bin/bash

# Pre-push hook for Spirit Flight Tracker
# This hook runs before pushing to remote repository

echo "ğŸš€ Running pre-push checks..."

# Get the remote name and URL
remote="$1"
url="$2"

echo "Pushing to: $remote ($url)"

# Run tests
echo "âœ“ Running validation checks..."

# Check all JavaScript files
for file in *.js; do
    if [ -f "$file" ]; then
        if command -v node &> /dev/null; then
            if ! node -c "$file" 2>&1; then
                echo "âŒ Syntax error in $file"
                echo "Fix the errors before pushing"
                exit 1
            fi
        fi
    fi
done

# Check for large files
echo "âœ“ Checking for large files..."
MAX_SIZE=5242880  # 5MB
large_files=$(find . -type f -size +${MAX_SIZE}c -not -path "./.git/*" 2>/dev/null)
if [ ! -z "$large_files" ]; then
    echo "âš ï¸  Warning: Large files detected:"
    echo "$large_files"
    read -p "Continue with push? (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Check for sensitive information
echo "âœ“ Checking for sensitive information..."
sensitive_patterns="password|api_key|secret|token|private_key"

# Get current branch
current_branch=$(git branch --show-current)

# Check if remote branch exists
if git rev-parse "origin/$current_branch" >/dev/null 2>&1; then
    # Remote branch exists, compare against it
    files_to_check=$(git diff origin/$current_branch --name-only)
else
    # First push - check all tracked files
    files_to_check=$(git ls-files)
fi

# Check for sensitive information in files
if [ ! -z "$files_to_check" ]; then
    if echo "$files_to_check" | xargs grep -iE "$sensitive_patterns" 2>/dev/null; then
        echo "âŒ Error: Potential sensitive information detected!"
        echo "Review your changes and remove sensitive data before pushing"
        exit 1
    fi
fi

# Verify README is up to date
if [ -f "README.md" ]; then
    echo "âœ“ README.md exists"
else
    echo "âš ï¸  Warning: README.md not found"
fi

echo "âœ… All pre-push checks passed!"
echo "ğŸš€ Proceeding with push..."
exit 0
